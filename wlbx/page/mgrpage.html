
<nav class="navbar navbar-default" role="navigation" id="adm_nav">
    <div class="container-fluid"> 
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"><span class="sr-only"></span><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button>
            <a class="navbar-brand" style="cursor: pointer;"><strong>管理员</strong></a> </div>
        
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li class="active"><a style="cursor: pointer;" id="waiting_confirm" onClick="init_adm_confirm();">待确认<span class="badge" id="waiting_confirm_num"></span></a></li>
                <li><a style="cursor: pointer;" id="waiting_schedule" onClick="init_adm_schedule();">待预约<span class="badge" id="waiting_schedule_num"></span></a></li>
                <li><a style="cursor: pointer;" id="waiting_me" onClick="init_adm_myduty();">我的任务<span class="badge" id="waiting_me_num"></span></a></li>
                <li><a style="cursor: pointer;" id="info_list" onClick="init_adm_report();">信息报表</a></li>
                <li class="dropdown"><a style="cursor: pointer;" class="dropdown-toggle" data-toggle="dropdown" id="my_duty">我的勤务<span class="caret"></span><span class="badge" id="my_duty_num"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li class="active"><a style="cursor: pointer;" id="already_schedule" onClick="init_adm_myduty();">已预约<span class="badge" id="already_schedule_num"></span></a></li>
                        <!--            <li><a href="#">今日任务<span class="badge"></span></a></li>-->
                        <li><a style="cursor: pointer;" id="already_repaired">已维修</a></li>
                        <li class="divider"></li>
                        <li><a style="cursor: pointer;" id="repair_delay" onClick="init_adm_delay();">维修暂缓<span class="badge" id="repair_delay_num"></span></a></li>
                        <li><a style="cursor: pointer;" id="repair_fail">维修失败<span class="badge" id="repair_fail_num"></span></a></li>
                        <li class="divider"></li>
                        <li><a style="cursor: pointer;" id="duty_list">个人出勤报表</a></li>
                        <li><a style="cursor: pointer;" id="report_list" onClick="init_adm_export();">报修统计表导出</a></li>
                    </ul>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a style="cursor: pointer;" onClick="adm_logout();">注销</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a style="cursor: pointer;" onClick="init_mgr_page();">页面管理</a></li>
                <li class="dropdown"> <a style="cursor: pointer;" class="dropdown-toggle" data-toggle="dropdown">用户管理<span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li><a style="cursor: pointer;">用户权限</a></li>
                        <li><a style="cursor: pointer;" onClick="init_my_profile();">用户资料</a></li>
                        <li><a style="cursor: pointer;" id="mgr_usr" onClick="init_mgr_usr();">管理其他用户</a></li>
                        <li class="divider"></li>
                        <li><a style="cursor: pointer;" id="qiangpiao_mgr" onClick="init_qiangpiao_mgr();">抢票管理</a></li>
                        <li><a style="cursor: pointer;">二次保护</a></li>
                        <li><a style="cursor: pointer;">微信重绑</a></li>
                    </ul>
                </li>
            </ul>
            <form class="navbar-form navbar-right" role="search" onKeyDown="if(event.keyCode == 13){adm_report_search();return false;}">
                <div class="input-group">
                    <div class="input-group-btn">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" id="search_item">搜索项目<span class="caret"></span></button>
                        <ul class="dropdown-menu" role="menu">
                            <li><a style="cursor: pointer;" id="search_repairid">报修ID</a></li>
                            <li class="divider"></li>
                            <li><a style="cursor: pointer;" id="search_stuid">学号</a></li>
                            <li><a style="cursor: pointer;" id="search_name">姓名</a></li>
                            <li><a style="cursor: pointer;" id="search_tel">电话</a></li>
                        </ul>
                    </div>
                    <!-- /btn-group -->
                    <input type="text" class="form-control" placeholder="Search" id="search_input">
                </div>
                <!-- /input-group -->
                <button type="button" class="btn btn-default" onClick="adm_report_search();">搜索</button>
            </form>
        </div>
        <!-- /.navbar-collapse --> 
    </div>
    <!-- /.container-fluid --> 
</nav>
<div class="panel panel-default"> 
    <!-- Default panel contents -->
    <div class="panel-heading" id="inf_title"></div>
    <div class="panel-body" id="inf_area"> </div>
    <table class="table table-striped table-hover">
        <thead id="inf_table_title">
        </thead>
        <tbody id="inf_table">
        </tbody>
    </table>
</div>

<!-- Modal -->
<div class="modal fade" id="addusr_fail" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span></button>
                <h4 class="modal-title">信息有误</h4>
            </div>
            <div class="modal-body">请您检查您填写的信息是否有误，或者您的微信是否已经注册。</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal">继续</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="confirm_fail" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span></button>
                <h4 class="modal-title">当前信息已经过时</h4>
            </div>
            <div class="modal-body">您操作的信息似乎已经过时，请重新刷新页面获取最新数据。</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" onClick="init_adm_confirm();">刷新</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="deny_reason" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span></button>
                <h4 class="modal-title">拒绝此报修的原因</h4>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="deny_reason_text" rows="5"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" onClick="adm_deny();">确认</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="repair_process" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span></button>
                <h4 class="modal-title">维修过程操作</h4>
            </div>
            <div class="modal-body">
                <div class="col-lg-12">
                    <button type="button" class="btn btn-lg btn-block btn-success" id="repair_process_success_btn" data-dismiss="modal">维修成功</button>
                </div>
                <div class="col-lg-12">
                    <p>&nbsp;</p>
                </div>
                <div class="col-lg-12">
                    <button type="button" class="btn btn-lg btn-block btn-warning" data-target="#repair_process_delay" data-toggle="modal">维修暂缓</button>
                </div>
                <div class="col-lg-12">
                    <p>&nbsp;</p>
                </div>
                <div class="col-lg-12">
                    <button type="button" class="btn btn-lg btn-block btn-danger" data-target="#repair_process_fail" data-toggle="modal">维修失败</button>
                </div>
                <div class="col-lg-12">
                    <p>&nbsp;</p>
                </div>
            </div>
            <div class="clearfix"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="repair_process_delay" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span></button>
                <h4 class="modal-title">维修暂缓原因</h4>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="repair_process_delay_text" rows="5"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" data-target="#repair_process" data-toggle="modal" id="repair_process_delay_btn">确认</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="repair_process_fail" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span></button>
                <h4 class="modal-title">维修失败原因</h4>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="repair_process_fail_text" rows="5"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" >取消</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" data-target="#repair_process" data-toggle="modal" id="repair_process_fail_btn">确认</button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
//adm 主体函数
var adm_numdata;

function adm_logout() {
    $.post("interface.php", {
        "usermgr": 'logout',
        "require":"usermanager"
    },
    function(data) {
        if (data.error === 0) {
                location.reload();
        } else {
        }
    },
    'json');
}
    
function adm_refreshnum() {
    if (adm_numdata.confirm === 0) {
        $("#waiting_confirm_num").hide();
    } else {
        $("#waiting_confirm_num").show();
        $("#waiting_confirm_num").empty();
        $("#waiting_confirm_num").append(adm_numdata.confirm);
    }

    if (adm_numdata.schedule1 === 0) {
        $("#waiting_schedule_num").hide();
    } else {
        $("#waiting_schedule_num").show();
        $("#waiting_schedule_num").empty();
        $("#waiting_schedule_num").append(adm_numdata.schedule1);
    }

    if (adm_numdata.repair === 0) {
        $("#waiting_me_num").hide();
    } else {
        $("#waiting_me_num").show();
        $("#waiting_me_num").empty();
        $("#waiting_me_num").append(adm_numdata.repair);
    }

    if (adm_numdata.repair === 0) {
        $("#already_schedule_num").hide();
    } else {
        $("#already_schedule_num").show();
        $("#already_schedule_num").empty();
        $("#already_schedule_num").append(adm_numdata.repair);
    }

    if (adm_numdata.delay + adm_numdata.schedule2 === 0) {
        $("#repair_delay_num").hide();
    } else {
        $("#repair_delay_num").show();
        $("#repair_delay_num").empty();
        $("#repair_delay_num").append(adm_numdata.delay + adm_numdata.schedule2);
    }

    if (adm_numdata.fail === 0) {
        $("#repair_fail_num").hide();
    } else {
        $("#repair_fail_num").show();
        $("#repair_fail_num").empty();
        $("#repair_fail_num").append(adm_numdata.fail);
    }

    if (adm_numdata.fail + adm_numdata.delay + adm_numdata.repair + adm_numdata.schedule2 === 0) {
        $("#my_duty_num").hide();
    } else {
        $("#my_duty_num").show();
        $("#my_duty_num").empty();
        $("#my_duty_num").append(adm_numdata.fail + adm_numdata.delay + adm_numdata.repair + adm_numdata.schedule2);
    }
}
function adm_getnum() {
    $.post("interface.php", {
        "datamgr": 'query_num',
        "require":"datamanager"
    },
    function(data) {
        if (data.error === 0) {
            adm_numdata = data;
            adm_refreshnum();
        }
    },
    'json');
}
var adm_searchopt;
var auto_refreash = {
    enable : 0,
    counter : 0,
    on : 0
};
var wechat_check = {
    enable : 0
};
$("#adm_nav a").on("click",function() {
    if ($(this).hasClass("dropdown-toggle") == false) {
        $("#adm_nav").find(".active").removeClass("active");
        $(this).parent().addClass("active");
        if($(this).attr("id") == "search_repairid" ||
           $(this).attr("id") == "search_stuid" ||
           $(this).attr("id") == "search_name" ||
           $(this).attr("id") == "search_tel"
          ){
            adm_searchopt = $(this).attr("id");
            $("#search_item").html($(this).text() + '<span class="caret">');
        }
        else {
            if($(this).attr("id") != "info_list"){
                auto_refreash.enable = 0;
            }
            if($(this).attr("id") != "mgr_usr"){
                wechat_check.enable = 0;
            }
        }
    }
});
    
function string_process(str){
    var str_p = "";
    for(var i = 0; i < str.length; i++ ){
        str_p += str[i];
        str_p += "&zwnj;";
    }
    //console.log("test_point");
    return str_p;
}

//adm 待确认业务代码
var confirmdata = {
    "nowpos": 0,
    "maxpos": 0,
    "data": ""
};
function adm_getnewtable_confirm() {
    $("#inf_table").empty();
    $.post("interface.php", {
        "datamgr": 'query_confirm',
        "require":"datamanager"
    },
    function(data) {
        confirmdata.data = data;
        if (data.error === 0) {
            if (data.contentlen > 0) {
				$("#inf_table").empty();
                confirmdata.nowpos = 0;
                confirmdata.maxpos = data.contentlen;
                $("#inf_title").empty();
                $("#inf_title").append('<small>#' + data[0].repairid + '#<small>&nbsp;&nbsp;');
               
				//marc 2018.9.23
				$("#inf_title").append('<strong>' + string_process(decode64(data[0].tel)) + '</strong>&nbsp;&nbsp;');
				
				$("#inf_title").append('<strong>' + string_process(decode64(data[0].name)) + '</strong>&nbsp;&nbsp;');
                $("#inf_title").append('<small>' + string_process(decode64(data[0].id)) + '<small>&nbsp;&nbsp;');
                $("#inf_title").append('<small>' + string_process(decode64(data[0].buildnum)) + form1_bulnum + '-' + string_process(decode64(data[0].section)) + '-' + string_process(decode64(data[0].floor)) + form1_floor + '-' + string_process(decode64(data[0].roomnum)) + form1_room + '-' + string_process(decode64(data[0].roomside)) + '</small>');
                $("#inf_detail").empty();
                $("#inf_detail").append(string_process(decode64(data[0].remark)));
                $("#inf_table").empty();
                for (var i = 1; i < data.contentlen; i++) {
                    var remark = decode64(data[i].remark);
                    if (remark.length >= 21) {
                        remark = remark.substr(0, 20) + "...";
                    }
                    $("#inf_table").append('<tr><td>' + data[i].repairid + '<td>' + string_process(decode64(data[i].tel)) + '</td><td>' +string_process(decode64(data[i].name)) + '</td><td>' + string_process(decode64(data[i].id)) + '</td><td>' + string_process(decode64(data[i].buildnum)) + form1_bulnum + '-' + string_process(decode64(data[i].section)) + '-' + string_process(decode64(data[i].floor)) + form1_floor + '-' + string_process(decode64(data[i].roomnum)) + form1_room + '-' + string_process(decode64(data[i].roomside)) + '</td><td>' + string_process(remark) + '</td><td>' + decode64(data[i].time) + '</td></tr>');
                }
            } else {
                $("#inf_success").hide();
                $("#inf_deny").hide();
                $("#inf_title").empty();
                $("#inf_detail").empty();
                $("#inf_title").append('暂无报修');
                $("#inf_detail").append('目前已经处理了所有的报修请求~');
            }
        }
    },
    'json');
}
function adm_confirm() {
    $.post("interface.php", {
        "datamgr": 'accept',
        "repairid": confirmdata.data[confirmdata.nowpos].repairid,
        "require":"datamanager"
    },
    function(data) {
        if (data.error === 0) {
            adm_numdata.schedule1++;
            adm_refreshnum();
            $("#inf_success").attr("disabled", "disabled");
            setTimeout(function() {
                $("#inf_success").removeAttr("disabled");
            },
            2500);
            adm_confirm_next();
        } else {
            $('#confirm_fail').modal('show');
        }
    },
    'json');
}
function adm_deny() {
    $.post("interface.php", {
        "datamgr": 'deny',
        "reason": $("#deny_reason_text").val(),
        "repairid": confirmdata.data[confirmdata.nowpos].repairid,
        "require":"datamanager"
    },
    function(data) {
        if (data.error === 0) {
            adm_confirm_next();
        } else {
            $('#confirm_fail').modal('show');
        }
    },
    'json');
    $("#deny_reason_text").val("");
}
function adm_confirm_next() {
    $("#inf_title").empty();
    $("#inf_detail").empty();
    if (confirmdata.nowpos < confirmdata.maxpos - 1) {
        adm_numdata.confirm--;
        adm_refreshnum();
        confirmdata.nowpos++;
        $("#inf_title").append('<small>#' + confirmdata.data[confirmdata.nowpos].repairid + '#<small>&nbsp;&nbsp;');
		$("#inf_title").append('<strong>' + string_process(decode64(confirmdata.data[confirmdata.nowpos].tel)) + '</strong>&nbsp;&nbsp;');
        $("#inf_title").append('<strong>' + string_process(decode64(confirmdata.data[confirmdata.nowpos].name)) + '</strong>&nbsp;&nbsp;');
        $("#inf_title").append('<small>' + string_process(decode64(confirmdata.data[confirmdata.nowpos].id)) + '<small>&nbsp;&nbsp;');
        $("#inf_title").append('<small>' + string_process(decode64(confirmdata.data[confirmdata.nowpos].buildnum)) + form1_bulnum + '-' + string_process(decode64(confirmdata.data[confirmdata.nowpos].section)) + '-' + string_process(decode64(confirmdata.data[confirmdata.nowpos].floor)) + form1_floor + '-' + string_process(decode64(confirmdata.data[confirmdata.nowpos].roomnum)) + form1_room + '-' + string_process(decode64(confirmdata.data[confirmdata.nowpos].roomside)) + '</small>');
        $("#inf_detail").append(string_process(decode64(confirmdata.data[confirmdata.nowpos].remark)));
        $("#inf_table tr:first-child").remove();
    } else {
        adm_numdata.confirm--;
        adm_refreshnum();
        $("#inf_success").hide();
        $("#inf_deny").hide();
        $("#inf_title").empty();
        $("#inf_detail").empty();
        $("#inf_title").append('暂无报修');
        $("#inf_detail").append('目前已经处理了所有的报修请求~');
    }
}
function init_adm_confirm_table_title() {
	$("#inf_table_title").empty();
//marc 2018.9.22
	$("#inf_table_title").append('<tr><th>报修ID</th><th>电话</th><th>姓名</th><th>学号</th><th>住址</th><th>描述</th><th>提交时间</th></tr>');
}
function init_adm_confirm_table() {
	$("#inf_table").empty();
}
function init_adm_confirm_detail() {
    $("#adm_confirm_btn_group").remove();
	$("#inf_area").empty();
	$("#inf_area").append('<p id="inf_detail"></p>');
    $("#inf_area").append('<div id="adm_confirm_btn_group"><div class="col-sm-4"><button type="button" class="btn btn-lg btn-block btn-success" id="inf_success" onClick="adm_confirm();">通过</button></div><div class="hidden-sm hidden-md hidden-lg"><p>&nbsp;</p></div><div class="col-sm-4 col-sm-offset-4"><button type="button" class="btn btn-lg btn-block btn-danger" id="inf_deny" data-target="#deny_reason" data-toggle="modal">拒绝</button></div></div>');
}
function init_adm_confirm() {
    adm_getnum();
    init_adm_confirm_detail();
	init_adm_confirm_table_title();
	init_adm_confirm_table();
    adm_getnewtable_confirm();
}
    
//adm 待预约业务代码
var scheduledata = {
	"data":""
}
function scheduledata_compare(property){
    return function(a, b){
        for(var i in property){
            if(typeof(a[property[i].prop]) != "undefined" && typeof(b[property[i].prop]) != "undefined"){
                if(property[i].type == "number"){
                    var v1 = Number(decode64(a[property[i].prop]));
                    var v2 = Number(decode64(b[property[i].prop]));
                    //console.log(typeof(a[property]));
                    if(v1 == v2){
                        continue;
                    }else{
                        return v1 - v2;
                    }
                }else if(property[i].type == "string"){
                    var v1 = decode64(a[property[i].prop]);
                    var v2 = decode64(b[property[i].prop]);
                    if(v1 == "I区" && v2 == "II区"){
                        return -1;
                    }else if(v1 == "II区" && v2 == "I区"){
                        return 1;
                    }else{
                        continue;
                    }
                }else{
                    continue;
                }
            }else{
                return 0;
            }
        }
    }
}
function scheduledata_sort(data){
    var arr = [];
    for(var i = 0; i < data.contentlen; i++){
        arr.push(data[i]);
    }
    data = arr;
    data.sort(scheduledata_compare({
                                   0:{"prop": "buildnum",
                                    "type": "number"},
                                   1:{"prop": "floor",
                                    "type": "number"},
                                   2:{"prop": "section",
                                    "type": "string"},
                                   3:{"prop": "roomnum",
                                    "type": "number"}
                                   }
        ));
    //console.log(typeof(data));
    return data;
}
function adm_getnewtable_schedule() {
    $("#inf_table").empty();
	$.post("interface.php", {
        "datamgr": 'query_schedule',
        "require":"datamanager"
    },
    function(data) {
        if (data.error === 0) {
            scheduledata.data = data;
            if (data.contentlen > 0) {
				$("#inf_table").empty();
                data = scheduledata_sort(data);
                //console.log("mark");
                //scheduledata_sort(data);
                for (var i = 0; i < data.length; i++) {
                    var remark = decode64(data[i].remark);
					var remarkmin = remark;
                    if (remark.length >= 21) {
                        remarkmin = remark.substr(0, 20) + "...";
                    }
					var free = JSON.parse(decode64(data[i].free));
					var freestr = "";
					for(var j = 0;j < free.length;j++){
						freestr += form1_label_time_list[Number(free[j])] + " ";
					}
					var freestrmin = freestr;
					if (freestr.length >= 21) {
                        freestrmin = freestr.substr(0, 20) + "...";
                    }
					freestr = "";
					for(var j = 0;j < free.length;j++){
						freestr += form1_label_time_list[Number(free[j])] + "<br>";
					}
                    $("#inf_table").append('<tr><td><input type="checkbox" name="check_schedule" value="' + data[i].repairid + '"></td><td>' + data[i].repairid + '<td>' + string_process(decode64(data[i].name)) + '</td><td>' + string_process(decode64(data[i].id)) + '</td><td>' + string_process(decode64(data[i].tel)) + '</td><td>' + string_process(decode64(data[i].buildnum)) + form1_bulnum + '-' + string_process(decode64(data[i].section)) + '-' + string_process(decode64(data[i].floor)) + form1_floor + '-' + string_process(decode64(data[i].roomnum)) + form1_room + '-' + string_process(decode64(data[i].roomside)) + '</td><td><span data-toggle="popover" data-placement="top" data-trigger="hover" data-content="' + string_process(remark) + '">' + string_process(remarkmin) + '</span></td><td>' + decode64(data[i].time) + '</td><td><span data-toggle="popover" data-placement="top" data-trigger="hover" data-content="' + freestr + '">' + freestrmin + '</span></td></tr>');
                }
            } else {
                $("#inf_title").empty();
                $("#inf_area").empty();
				$("#inf_area").append('<p id="inf_detail"></p>');
                $("#inf_title").append('暂无预约');
                $("#inf_detail").append('目前已经处理了所有的预约请求~');
                $("#inf_table").empty();
            }
			$('[data-toggle="popover"]').popover({html:true});
        }
    },
    'json');
}
function adm_table_check_all_schedule() {
	if($("#select_all")[0].checked){
		$('input:checkbox[name="check_schedule"]').each(function() {
			$(this)[0].checked = true;
		});
	}else{
		$('input:checkbox[name="check_schedule"]').each(function() {
			$(this)[0].checked = false;
		});
	}
}
function adm_table_schedule_select() {
	var array = new Array(scheduledata.data.contentlen);
	for(var i = 0;i < scheduledata.data.contentlen;i++){
		array[i] = 1;
	}
	var day = 0;
	//alert(array.toString());
	/*if($("#select_time").val() !== ''){
		var myDate = new Date();
		myDate.setDate($("#select_time").val().substr(8,2));
		myDate.setMonth((Number($("#select_time").val().substr(5,2)) - 1).toString());
		myDate.setFullYear($("#select_time").val().substr(0,4));
		day = myDate.getDay();
		//alert($("#select_time").val()+"//"+day);
		for(var i = 0;i < scheduledata.data.contentlen;i++){
			var flag = false;
			var free = JSON.parse(decode64(scheduledata.data[i].free));
			for(var j = 0;j < free.length;j++){
				if(Number(free[j]) === ((day - 1) * 2) || Number(free[j]) === ((day - 1) * 2 + 1)){
					flag = true;
					break;
				}
			}
			if(!flag){
				array[i] = 0;
			}
		}
	}
	//alert(array.toString());
	if($("#time1")[0].checked === false && $("#time2")[0].checked === false && day !== 0){
		//alert("1");
	}else if($("#time1")[0].checked === false && day !== 0){
		//alert("2");
		for(var i = 0;i < scheduledata.data.contentlen;i++){
			if(array[i] === 1){
				var flag = false;
				var free = JSON.parse(decode64(scheduledata.data[i].free));
				for(var j = 0;j < free.length;j++){
					if(Number(free[j]) === ((day - 1) * 2 + 1)){
						flag = true;
						break;
					}
				}
				if(!flag){
					array[i] = 0;
				}
			}
		}
	}else if($("#time2")[0].checked === false && day !== 0){
		//alert("3");
		for(var i = 0;i < scheduledata.data.contentlen;i++){
			if(array[i] === 1){
				var flag = false;
				var free = JSON.parse(decode64(scheduledata.data[i].free));
				for(var j = 0;j < free.length;j++){
					if(Number(free[j]) === ((day - 1) * 2)){
						flag = true;
						break;
					}
				}
				if(!flag){
					array[i] = 0;
				}
			}
		}
	}*/
	//alert(array.toString());
	if(Number($("#adm_building").val()) !== 0){
		for(var i = 0;i < scheduledata.data.contentlen;i++){
			if(array[i] === 1){
				if(Number(decode64(scheduledata.data[i].buildnum)) !== Number($("#adm_building").val())){
					array[i] = 0;
				}
			}
		}
	}
	//alert(array.toString());
	$("#inf_table").empty();
	for(var i = 0;i < scheduledata.data.contentlen;i++){
		if(array[i] === 1){
			var remark = decode64(scheduledata.data[i].remark);
			var remarkmin = remark;
			if (remark.length >= 21) {
				remarkmin = remark.substr(0, 20) + "...";
			}
			var free = JSON.parse(decode64(scheduledata.data[i].free));
			var freestr = "";
			for(var j = 0;j < free.length;j++){
				freestr += form1_label_time_list[Number(free[j])] + " ";
			}
			var freestrmin = freestr;
			if (freestr.length >= 21) {
				freestrmin = freestr.substr(0, 20) + "...";
			}
			freestr = "";
			for(var j = 0;j < free.length;j++){
				freestr += form1_label_time_list[Number(free[j])] + "<br>";
			}
			$("#inf_table").append('<tr><td><input type="checkbox" name="check_schedule" value="' + scheduledata.data[i].repairid + '"></td><td>' + scheduledata.data[i].repairid + '<td>' + string_process(decode64(scheduledata.data[i].name)) + '</td><td>' + string_process(decode64(scheduledata.data[i].id)) + '</td><td>' + string_process(decode64(scheduledata.data[i].tel)) + '</td><td>' + string_process(decode64(scheduledata.data[i].buildnum)) + form1_bulnum + '-' + string_process(decode64(scheduledata.data[i].section)) + '-' + string_process(decode64(scheduledata.data[i].floor)) + form1_floor + '-' + string_process(decode64(scheduledata.data[i].roomnum)) + form1_room + '-' + string_process(decode64(scheduledata.data[i].roomside)) + '</td><td><span data-toggle="popover" data-placement="top" data-trigger="hover" data-content="' + string_process(remark) + '">' + string_process(remarkmin) + '</span></td><td>' + decode64(scheduledata.data[i].time) + '</td><td><span data-toggle="popover" data-placement="top" data-trigger="hover" data-content="' + freestr + '">' + freestrmin + '</span></td></tr>');
			$('[data-toggle="popover"]').popover({html:true});
		}
	}
	
	if($("#select_time").val() !== '' && ($("#time1")[0].checked === false && $("#time2")[0].checked === false) === false){
		$("#adm_schedule_submit").removeAttr("disabled");
	}
}
function adm_table_schedule_preselect() {
	if($("#select_time").val() !== '' && ($("#time1")[0].checked === false && $("#time2")[0].checked === false) === false){
		$("#adm_schedule_submit").removeAttr("disabled");
	}
}
function adm_schedule_submit() {
	var id = new Array();
	var date = $("#select_time").val() + " ";
	if($("#time1")[0].checked === true){
		date += "晚上7-9点";
	}else if($("#time2")[0].checked === true){
		date += "晚上9-11点";
	}
	$('input:checkbox[name="check_schedule"]:checked').each(function() {
		id.push($(this).val());
	});
	//var jsonid = JSON.stringify(id);
	if(id.length > 0){
		for(var i = 0;i < id.length;i++){
			$.post("interface.php",{
				"id":id[i],
				"date":date,
				"datamgr":"schedule",
                "require":"datamanager"
			},function(data) {
				if(data.error === 0){
					adm_numdata.schedule1--;
					adm_numdata.repair++;
        			adm_refreshnum();
				}else if(data.error === 1){
					$('#confirm_fail').modal('show');
				}
			},'json');
		}
		init_adm_schedule();
	}
}
function init_adm_schedule_table_title() {
	$("#inf_table_title").empty();
	$("#inf_table_title").append('<tr><th>选择<input type="checkbox" id="select_all" onChange="adm_table_check_all_schedule();"></th><th>报修ID</th><th>姓名</th><th>学号</th><th>电话号码</th><th>住址</th><th>描述</th><th>提交时间</th><th>预约时间</th></tr>');
}
function init_adm_schedule_select() {
	$("#inf_title").empty();
	$("#inf_title").append('<strong>筛选条件</strong>');
	$("#inf_area").empty();
	//$("#inf_area").append('<div class="form-group col-lg-6 col-lg-offset-3"><div class="input-append date" id="datetimepicker" data-date-format="yyyy-mm-dd"><label class="col-lg-3 control-label">预约时间：</label><div class="col-lg-9"><input class="form-control span2" id="select_time" onChange="adm_table_schedule_select();" style="cursor: pointer;" size="16" type="text" readonly><span class="add-on"><i class="icon-th"></i></span></div></div><div><label class="col-lg-3 control-label">维护时间：</label><div class="col-lg-9" id="rtime"></div></div><div><label class="col-lg-3 control-label">楼号：</label><div class="col-lg-9"><select class="form-control" onChange="adm_table_schedule_select();" id="adm_building"></select></div></div><div><div class="col-lg-3 col-lg-offset-6"><button class="btn btn-primary btn-lg btn-block" id="adm_schedule_submit" onClick="adm_schedule_submit();" disabled>提交</button></div></div></div>');
    $("#inf_area").append('<div class="form-group col-lg-6 col-lg-offset-3"><div class="input-append date" id="datetimepicker" data-date-format="yyyy-mm-dd"><label class="col-lg-3 control-label">预约时间：</label><div class="col-lg-9"><input class="form-control span2" id="select_time" onChange="adm_table_schedule_preselect();" style="cursor: pointer;" size="16" type="text" readonly><span class="add-on"><i class="icon-th"></i></span></div></div><div><label class="col-lg-3 control-label">维护时间：</label><div class="col-lg-9" id="rtime"></div></div><div><label class="col-lg-3 control-label">楼号：</label><div class="col-lg-9"><select class="form-control" onChange="adm_table_schedule_select();" id="adm_building"></select></div></div><div><div class="col-lg-3 col-lg-offset-6"><button class="btn btn-primary btn-lg btn-block" id="adm_schedule_submit" onClick="adm_schedule_submit();" disabled>提交</button></div></div></div>');
	var myDate = new Date();
    var dateStart = myDate.getFullYear().toString() + '-' + (myDate.getMonth() + 1).toString() + '-' + myDate.getDate().toString();
    myDate.setDate(myDate.getDate() + 7);
    var dateEnd = myDate.getFullYear().toString() + '-' + (myDate.getMonth() + 1).toString() + '-' + myDate.getDate().toString();
	$('#datetimepicker').datetimepicker({
        language:  'zh-CN',
        weekStart: 0,
        todayBtn:  0,
        startDate: dateStart,
        endDate: dateEnd,
        daysOfWeekDisabled: [0,6],
		autoclose: 1,
		todayHighlight: 1,
		startView: 2,
		minView: 2,
		forceParse: 0
    });
	$("#adm_building").append('<option value="0">---请选择---</option>');
	for(var i=0;i<form1_bulnum_list.length;i++){
		$("#adm_building").append('<option value="'+form1_bulnum_list[i]+'">'+form1_bulnum_list[i]+form1_bulnum+'</option>');
	}
	//$("#rtime").append('<div data-toggle="buttons"><label class="btn btn-primary btn-lg" onChange="adm_table_schedule_select();" for="time1" id="label_time1"><input type="radio" autocomplete="off" name="rtime" value="0" id="time1">7点到9点</label><label class="btn btn-primary btn-lg" onChange="adm_table_schedule_select();" for="time2" id="label_time2"><input type="radio" autocomplete="off" name="rtime" value="1" id="time2">9点到11点</label></div>');
    $("#rtime").append('<div data-toggle="buttons"><label class="btn btn-primary btn-lg" onChange="adm_table_schedule_preselect();" for="time1" id="label_time1"><input type="radio" autocomplete="off" name="rtime" value="0" id="time1">7点到9点</label><label class="btn btn-primary btn-lg" onChange="adm_table_schedule_preselect();" for="time2" id="label_time2"><input type="radio" autocomplete="off" name="rtime" value="1" id="time2">9点到11点</label></div>');
	
}
function init_adm_schedule() {
	adm_getnum();
	init_adm_schedule_select();
	init_adm_schedule_table_title();
	adm_getnewtable_schedule();
	//$('[data-toggle="popover"]').popover(); 
}

//init_adm_confirm();
//adm 我的任务
var dutydata = {
	"data":""
}
function myduty_compare(property){
    return function(a, b){
        for(var i in property){
            if(typeof(a[property[i].prop]) != "undefined" && typeof(b[property[i].prop]) != "undefined"){
                if(property[i].type == "number"){
                    var v1 = Number(decode64(a[property[i].prop]));
                    var v2 = Number(decode64(b[property[i].prop]));
                    //console.log(typeof(a[property]));
                    if(v1 == v2){
                        continue;
                    }else{
                        return v1 - v2;
                    }
                }else if(property[i].type == "string"){
                    var v1 = decode64(a[property[i].prop]);
                    var v2 = decode64(b[property[i].prop]);
                    if(v1 == "I区" && v2 == "II区"){
                        return -1;
                    }else if(v1 == "II区" && v2 == "I区"){
                        return 1;
                    }else{
                        continue;
                    }
                }else{
                    continue;
                }
            }else{
                return 0;
            }
        }
    }
}
function myduty_sort(data){
    var arr = [];
    for(var i = 0; i < data.contentlen; i++){
        arr.push(data[i]);
    }
    data = arr;
    data.sort(myduty_compare({
                                   0:{"prop": "buildnum",
                                    "type": "number"},
                                   1:{"prop": "floor",
                                    "type": "number"},
                                   2:{"prop": "section",
                                    "type": "string"},
                                   3:{"prop": "roomnum",
                                    "type": "number"}
                                   }
        ));
    //console.log(typeof(data));
    return data;
}
function init_adm_myduty_title() {
    $("#inf_title").empty();
	$("#inf_title").append('<strong>我的任务</strong>');
	$("#inf_area").empty();
    $("#inf_area").append('<p>当前已经预约的任务如下。</p>');
    $("#inf_area").append('<a style="cursor: pointer;" onClick="adm_myduty_export();">导出至文件</a>');
}
function init_adm_myduty_table_title() {
    $("#inf_table_title").empty();
	$("#inf_table_title").append('<tr><th>报修ID</th><th>姓名</th><th>学号</th><th>电话号码</th><th>住址</th><th>描述</th><th>提交时间</th><th>预约时间</th><th>操作</th></tr>');
}
function adm_repair_process(repairid) {
    $('#repair_process').modal('show');
    $('#repair_process_success_btn').attr("onClick","adm_repair_process_success(\""+repairid+"\");");
    $('#repair_process_delay_btn').attr("onClick","adm_repair_process_delay(\""+repairid+"\");");
    $('#repair_process_fail_btn').attr("onClick","adm_repair_process_fail(\""+repairid+"\");");
}
function adm_repair_process_success(repairid) {
    $.post("interface.php", {
        "datamgr": 'myduty_repair_success',
        "repairid": repairid,
        "require":"datamanager"
    },function(data){
        if(data.error === 0){
            init_adm_myduty();
        }else{
            $("#confirm_fail").modal('show');
        }
    },'json');
}
function adm_repair_process_delay(repairid) {
    $.post("interface.php", {
        "datamgr": 'myduty_repair_delay',
        "repairid": repairid,
        "reason": $("#repair_process_delay_text").val(),
        "require":"datamanager"
    },function(data){
        if(data.error === 0){
            init_adm_myduty();
        }else{
            $("#confirm_fail").modal('show');
        }
    },'json');
}
function adm_repair_process_fail(repairid) {
    $.post("interface.php", {
        "datamgr": 'myduty_repair_fail',
        "repairid": repairid,
        "reason": $("#repair_process_fail_text").val(),
        "require":"datamanager"
    },function(data){
        if(data.error === 0){
            init_adm_myduty();
        }else{
            $("#confirm_fail").modal('show');
        }
    },'json');
}
function adm_getnewtable_myduty(repairid) {
    $("#inf_table").empty();
    $.post("interface.php", {
        "datamgr": 'query_myduty',
        "require":"datamanager"
    },
    function(data) {
        dutydata.data = data;
        if (data.error === 0) {
            if (data.contentlen > 0) {
				$("#inf_table").empty();
                data = myduty_sort(data);
                //console.log("here");
                for (var i = 0; i < data.length; i++) {
                        var remark = decode64(data[i].remark);
                        var remarkmin = remark;
                        if (remark.length >= 21) {
                            remarkmin = remark.substr(0, 20) + "...";
                        }
                        $("#inf_table").append('<tr><td>' + data[i].repairid + '<td>' + string_process(decode64(data[i].name)) + '</td><td>' + string_process(decode64(data[i].id)) + '</td><td>' + string_process(decode64(data[i].tel)) + '</td><td>' + string_process(decode64(data[i].buildnum)) + form1_bulnum + '-' + string_process(decode64(data[i].section)) + '-' + string_process(decode64(data[i].floor)) + form1_floor + '-' + string_process(decode64(data[i].roomnum)) + form1_room + '-' + string_process(decode64(data[i].roomside)) + '</td><td><span data-toggle="popover" data-placement="top" data-trigger="hover" data-content="' + string_process(remark) + '">' + string_process(remarkmin) + '</span></td><td>' + decode64(data[i].time) + '</td><td><span data-toggle="popover" data-placement="top" data-trigger="hover" data-content="' + decode64(data[i].exptime) + '">' + decode64(data[i].exptime) + '</span></td><td><button class="btn btn-lg btn-success" onClick="adm_repair_process(\''+data[i].repairid+'\');">维修操作</td></tr>'); 
                }
            } else {
                $("#inf_title").empty();
                $("#inf_area").empty();
				$("#inf_area").append('<p id="inf_detail"></p>');
                $("#inf_title").append('暂无任务');
                $("#inf_detail").append('目前已经处理了所有的任务~');
                $("#inf_table").empty();
            }
			$('[data-toggle="popover"]').popover({html:true});
        }
    },
    'json');
}
function adm_myduty_export() {
    var data = dutydata.data;
    if (data.error === 0) {
        if (data.contentlen > 0) {
            data = myduty_sort(data);
            //console.log("here");
            var export_file = "报修ID,姓名,学号,电话,住址\n";
            for (var i = 0; i < data.length; i++) {
                export_file += data[i].repairid + ',' + decode64(data[i].name) + ',' + decode64(data[i].id) + ',' + decode64(data[i].tel) + ',' + decode64(data[i].buildnum) + form1_bulnum + '-' + decode64(data[i].section) + '-' + decode64(data[i].floor) + form1_floor + '-' + decode64(data[i].roomnum) + form1_room + '-' + decode64(data[i].roomside) + '\n';
            }
            var exportContent = "\uFEFF";
            var blob = new Blob([exportContent + export_file],{type: "text/plain;charset=utf-8"});
            var myDate = new Date();
            saveAs(blob, "我的勤务_" + myDate.getFullYear() + "_" + myDate.getMonth() + "_" +myDate.getDate() + ".csv");
        }
    }
}
function init_adm_myduty() {
    adm_getnum();
	init_adm_myduty_title();
	init_adm_myduty_table_title();
	adm_getnewtable_myduty();
}

//已暂缓
var delaydata = {
	"data":""
}
function adm_getnewtable_delay() {
    $("#inf_table").empty();
	$.post("interface.php", {
        "datamgr": 'query_delay',
        "require":"datamanager"
    },
    function(data) {
        delaydata.data = data;
        if (data.error === 0) {
            if (data.contentlen > 0) {
				$("#inf_table").empty();
                for (var i = 0; i < data.contentlen; i++) {
                    var remark = decode64(data[i].remark);
					var remarkmin = remark;
                    if (remark.length >= 21) {
                        remarkmin = remark.substr(0, 20) + "...";
                    }
					var free = JSON.parse(decode64(data[i].free));
					var freestr = "";
					for(var j = 0;j < free.length;j++){
						freestr += form1_label_time_list[Number(free[j])] + " ";
					}
					var freestrmin = freestr;
					if (freestr.length >= 21) {
                        freestrmin = freestr.substr(0, 20) + "...";
                    }
					freestr = "";
					for(var j = 0;j < free.length;j++){
						freestr += form1_label_time_list[Number(free[j])] + "<br>";
					}
                    $("#inf_table").append('<tr><td><input type="checkbox" name="check_delay" value="' + data[i].repairid + '"></td><td>' + data[i].repairid + '<td>' + string_process(decode64(data[i].name)) + '</td><td>' + string_process(decode64(data[i].id)) + '</td><td>' + string_process(decode64(data[i].tel)) + '</td><td>' + string_process(decode64(data[i].buildnum)) + form1_bulnum + '-' + string_process(decode64(data[i].section)) + '-' + string_process(decode64(data[i].floor)) + form1_floor + '-' + string_process(decode64(data[i].roomnum)) + form1_room + '-' + string_process(decode64(data[i].roomside)) + '</td><td><span data-toggle="popover" data-placement="top" data-trigger="hover" data-content="' + string_process(remark) + '">' + string_process(remarkmin) + '</span></td><td>' + decode64(data[i].time) + '</td><td><span data-toggle="popover" data-placement="top" data-trigger="hover" data-content="' + freestr + '">' + freestrmin + '</span></td></tr>');
                }
            } else {
                $("#inf_title").empty();
                $("#inf_area").empty();
				$("#inf_area").append('<p id="inf_detail"></p>');
                $("#inf_title").append('暂无预约');
                $("#inf_detail").append('目前已经处理了所有的预约请求~');
                $("#inf_table").empty();
            }
			$('[data-toggle="popover"]').popover({html:true});
        }
    },
    'json');
}
function adm_table_check_all_delay() {
	if($("#select_all")[0].checked){
		$('input:checkbox[name="check_delay"]').each(function() {
			$(this)[0].checked = true;
		});
	}else{
		$('input:checkbox[name="check_delay"]').each(function() {
			$(this)[0].checked = false;
		});
	}
}
function adm_table_delay_select() {
	var array = new Array(delaydata.data.contentlen);
	for(var i = 0;i < delaydata.data.contentlen;i++){
		array[i] = 1;
	}
	var day = 0;
	//alert(array.toString());
/*	if($("#select_time").val() !== ''){
		var myDate = new Date();
		myDate.setDate($("#select_time").val().substr(8,2));
		myDate.setMonth((Number($("#select_time").val().substr(5,2)) - 1).toString());
		myDate.setFullYear($("#select_time").val().substr(0,4));
		day = myDate.getDay();
		//alert(day);
		for(var i = 0;i < delaydata.data.contentlen;i++){
			var flag = false;
			var free = JSON.parse(decode64(delaydata.data[i].free));
			for(var j = 0;j < free.length;j++){
				if(Number(free[j]) === ((day - 1) * 2) || Number(free[j]) === ((day - 1) * 2 + 1)){
					flag = true;
					break;
				}
			}
			if(!flag){
				array[i] = 0;
			}
		}
	}
	//alert(array.toString());
	if($("#time1")[0].checked === false && $("#time2")[0].checked === false && day !== 0){
		//alert("1");
	}else if($("#time1")[0].checked === false && day !== 0){
		//alert("2");
		for(var i = 0;i < delaydata.data.contentlen;i++){
			if(array[i] === 1){
				var flag = false;
				var free = JSON.parse(decode64(delaydata.data[i].free));
				for(var j = 0;j < free.length;j++){
					if(Number(free[j]) === ((day - 1) * 2 + 1)){
						flag = true;
						break;
					}
				}
				if(!flag){
					array[i] = 0;
				}
			}
		}
	}else if($("#time2")[0].checked === false && day !== 0){
		//alert("3");
		for(var i = 0;i < delaydata.data.contentlen;i++){
			if(array[i] === 1){
				var flag = false;
				var free = JSON.parse(decode64(delaydata.data[i].free));
				for(var j = 0;j < free.length;j++){
					if(Number(free[j]) === ((day - 1) * 2)){
						flag = true;
						break;
					}
				}
				if(!flag){
					array[i] = 0;
				}
			}
		}
	}*/
	//alert(array.toString());
	if(Number($("#adm_building").val()) !== 0){
		for(var i = 0;i < delaydata.data.contentlen;i++){
			if(array[i] === 1){
				if(Number(decode64(delaydata.data[i].buildnum)) !== Number($("#adm_building").val())){
					array[i] = 0;
				}
			}
		}
	}
	//alert(array.toString());
	$("#inf_table").empty();
	for(var i = 0;i < delaydata.data.contentlen;i++){
		if(array[i] === 1){
			var remark = decode64(delaydata.data[i].remark);
			var remarkmin = remark;
			if (remark.length >= 21) {
				remarkmin = remark.substr(0, 20) + "...";
			}
			var free = JSON.parse(decode64(delaydata.data[i].free));
			var freestr = "";
			for(var j = 0;j < free.length;j++){
				freestr += form1_label_time_list[Number(free[j])] + " ";
			}
			var freestrmin = freestr;
			if (freestr.length >= 21) {
				freestrmin = freestr.substr(0, 20) + "...";
			}
			freestr = "";
			for(var j = 0;j < free.length;j++){
				freestr += form1_label_time_list[Number(free[j])] + "<br>";
			}
			$("#inf_table").append('<tr><td><input type="checkbox" name="check_delay" value="' + delaydata.data[i].repairid + '"></td><td>' + delaydata.data[i].repairid + '<td>' + string_process(decode64(delaydata.data[i].name)) + '</td><td>' + string_process(decode64(delaydata.data[i].id)) + '</td><td>' + string_process(decode64(delaydata.data[i].tel)) + '</td><td>' + string_process(decode64(delaydata.data[i].buildnum)) + form1_bulnum + '-' + string_process(decode64(delaydata.data[i].section)) + '-' + string_process(decode64(delaydata.data[i].floor)) + form1_floor + '-' + string_process(decode64(delaydata.data[i].roomnum)) + form1_room + '-' + string_process(decode64(delaydata.data[i].roomside)) + '</td><td><span data-toggle="popover" data-placement="top" data-trigger="hover" data-content="' + string_process(remark) + '">' + string_process(remarkmin) + '</span></td><td>' + decode64(delaydata.data[i].time) + '</td><td><span data-toggle="popover" data-placement="top" data-trigger="hover" data-content="' + freestr + '">' + freestrmin + '</span></td></tr>');
			$('[data-toggle="popover"]').popover({html:true});
		}
	}
	
	if($("#select_time").val() !== '' && ($("#time1")[0].checked === false && $("#time2")[0].checked === false) === false){
		$("#adm_delay_submit").removeAttr("disabled");
	}
}
function adm_table_delay_preselect() {
	if($("#select_time").val() !== '' && ($("#time1")[0].checked === false && $("#time2")[0].checked === false) === false){
		$("#adm_delay_submit").removeAttr("disabled");
	}
}
function adm_delay_submit() {
	var id = new Array();
	var date = $("#select_time").val() + " ";
	if($("#time1")[0].checked === true){
		date += "晚上7-9点";
	}else if($("#time2")[0].checked === true){
		date += "晚上9-11点";
	}
	$('input:checkbox[name="check_delay"]:checked').each(function() {
		id.push($(this).val());
	});
	//var jsonid = JSON.stringify(id);
	if(id.length > 0){
		for(var i = 0;i < id.length;i++){
			$.post("interface.php",{
				"id":id[i],
				"date":date,
				"datamgr":"reschedule",
                "require":"datamanager"
			},function(data) {
				if(data.error === 0){
					adm_numdata.delay1--;
					adm_numdata.repair++;
        			adm_refreshnum();
				}else if(data.error === 1){
					$('#confirm_fail').modal('show');
				}
			},'json');
		}
		init_adm_delay();
	}
}
function init_adm_delay_table_title() {
	$("#inf_table_title").empty();
	$("#inf_table_title").append('<tr><th>选择<input type="checkbox" id="select_all" onChange="adm_table_check_all_delay();"></th><th>报修ID</th><th>姓名</th><th>学号</th><th>电话号码</th><th>住址</th><th>描述</th><th>提交时间</th><th>预约时间</th></tr>');
}
function init_adm_delay_select() {
	$("#inf_title").empty();
	$("#inf_title").append('<strong>筛选条件</strong>');
	$("#inf_area").empty();
	//$("#inf_area").append('<div class="form-group col-lg-6 col-lg-offset-3"><div class="input-append date" id="datetimepicker" data-date-format="yyyy-mm-dd"><label class="col-lg-3 control-label">预约时间：</label><div class="col-lg-9"><input class="form-control span2" id="select_time" onChange="adm_table_delay_select();" style="cursor: pointer;" size="16" type="text" readonly><span class="add-on"><i class="icon-th"></i></span></div></div><div><label class="col-lg-3 control-label">维护时间：</label><div class="col-lg-9" id="rtime"></div></div><div><label class="col-lg-3 control-label">楼号：</label><div class="col-lg-9"><select class="form-control" onChange="adm_table_delay_select();" id="adm_building"></select></div></div><div><div class="col-lg-3 col-lg-offset-6"><button class="btn btn-primary btn-lg btn-block" id="adm_delay_submit" onClick="adm_delay_submit();" disabled>提交</button></div></div></div>');
    $("#inf_area").append('<div class="form-group col-lg-6 col-lg-offset-3"><div class="input-append date" id="datetimepicker" data-date-format="yyyy-mm-dd"><label class="col-lg-3 control-label">预约时间：</label><div class="col-lg-9"><input class="form-control span2" id="select_time" onChange="adm_table_delay_preselect();" style="cursor: pointer;" size="16" type="text" readonly><span class="add-on"><i class="icon-th"></i></span></div></div><div><label class="col-lg-3 control-label">维护时间：</label><div class="col-lg-9" id="rtime"></div></div><div><label class="col-lg-3 control-label">楼号：</label><div class="col-lg-9"><select class="form-control" onChange="adm_table_delay_select();" id="adm_building"></select></div></div><div><div class="col-lg-3 col-lg-offset-6"><button class="btn btn-primary btn-lg btn-block" id="adm_delay_submit" onClick="adm_delay_submit();" disabled>提交</button></div></div></div>');
	var myDate = new Date();
    var dateStart = myDate.getFullYear().toString() + '-' + (myDate.getMonth() + 1).toString() + '-' + myDate.getDate().toString();
    myDate.setDate(myDate.getDate() + 7);
    var dateEnd = myDate.getFullYear().toString() + '-' + (myDate.getMonth() + 1).toString() + '-' + myDate.getDate().toString();
	$('#datetimepicker').datetimepicker({
        language:  'zh-CN',
        weekStart: 0,
        todayBtn:  0,
        startDate: dateStart,
        endDate: dateEnd,
        daysOfWeekDisabled: [0,6],
		autoclose: 1,
		todayHighlight: 1,
		startView: 2,
		minView: 2,
		forceParse: 0
    });
	$("#adm_building").append('<option value="0">---请选择---</option>');
	for(var i=0;i<form1_bulnum_list.length;i++){
		$("#adm_building").append('<option value="'+form1_bulnum_list[i]+'">'+form1_bulnum_list[i]+form1_bulnum+'</option>');
	}
	//$("#rtime").append('<div data-toggle="buttons"><label class="btn btn-primary btn-lg" onChange="adm_table_delay_select();" for="time1" id="label_time1"><input type="radio" autocomplete="off" name="rtime" value="0" id="time1">7点到9点</label><label class="btn btn-primary btn-lg" onChange="adm_table_delay_select();" for="time2" id="label_time2"><input type="radio" autocomplete="off" name="rtime" value="1" id="time2">9点到11点</label></div>');
    $("#rtime").append('<div data-toggle="buttons"><label class="btn btn-primary btn-lg" onChange="adm_table_delay_preselect();" for="time1" id="label_time1"><input type="radio" autocomplete="off" name="rtime" value="0" id="time1">7点到9点</label><label class="btn btn-primary btn-lg" onChange="adm_table_delay_preselect();" for="time2" id="label_time2"><input type="radio" autocomplete="off" name="rtime" value="1" id="time2">9点到11点</label></div>');
	
}
function init_adm_delay() {
	adm_getnum();
	init_adm_delay_select();
	init_adm_delay_table_title();
	adm_getnewtable_delay();
	//$('[data-toggle="popover"]').popover(); 
}
//init_adm_confirm();
//adm 我的任务
    
    
//信息报表
var reportdata = {
	"data":"",
    "page":0,
    "capa":50,
    "tot_num":0
}
function adm_getnewtable_report() {
    $("#inf_table").empty();
    $("#inf_table_title").empty();
	$("#inf_table_title").append('<tr><th>报修ID</th><th>姓名</th><th>学号</th><th>电话号码</th><th>住址</th><th>描述</th><th>处理人</th><th>处理结果</th></tr>');
	$.post("interface.php", {
        "datamgr":'query_report',
        "require":"datamanager",
        "start":reportdata.page * reportdata.capa,
        "capa":reportdata.capa
    },
    function(data) {
        reportdata.data = data;
        if (data.error === 0) {
            if (data.contentlen > 0) {
				$("#inf_table").empty();
                //console.log("report");
               for (var i = 0; i < data.contentlen; i++) {
                    var remark = decode64(data[i].remark);
					var remarkmin = remark;
                    if (remark.length >= 21) {
                        remarkmin = remark.substr(0, 20) + "...";
                    }
                    if(decode64(data[i].status) == "0"){
                        $("#inf_table").append('<tr class="success"><td>' + data[i].repairid + '</td><td>' + string_process(decode64(data[i].name)) + '</td><td>' + string_process(decode64(data[i].id)) + '</td><td>' + string_process(decode64(data[i].tel)) + '</td><td>' + string_process(decode64(data[i].buildnum)) + form1_bulnum + '-' + string_process(decode64(data[i].section)) + '-' + string_process(decode64(data[i].floor)) + form1_floor + '-' + string_process(decode64(data[i].roomnum)) + form1_room + '-' + string_process(decode64(data[i].roomside)) + '</td><td><span data-toggle="popover" data-placement="top" data-trigger="hover" data-content="' + string_process(remark) + '">' + string_process(remarkmin) + '</span></td><td>' + decode64(data[i].processer) + '</td><td>'+ '处理完成' + '</td></tr>');
                    }else{
                        $("#inf_table").append('<tr class="warning"><td>' + data[i].repairid + '</td><td>' + string_process(decode64(data[i].name)) + '</td><td>' + string_process(decode64(data[i].id)) + '</td><td>' + string_process(decode64(data[i].tel)) + '</td><td>' + string_process(decode64(data[i].buildnum)) + form1_bulnum + '-' + string_process(decode64(data[i].section)) + '-' + string_process(decode64(data[i].floor)) + form1_floor + '-' + string_process(decode64(data[i].roomnum)) + form1_room + '-' + string_process(decode64(data[i].roomside)) + '</td><td><span data-toggle="popover" data-placement="top" data-trigger="hover" data-content="' + string_process(remark) + '">' + string_process(remarkmin) + '</span></td><td>' + decode64(data[i].processer) + '</td><td>'+ '处理中' + '</td></tr>');
                    }
                }
                $("#inf_table").append('<tr><td></td><td></td><td></td><td></td><td><div class="btn-group" role="group" aria-label="页面"><button type="button" class="btn btn-default" onClick="adm_report_front_page();">上一页</button><button type="button" class="btn btn-default">' + (reportdata.page + 1) + '</button><button type="button" class="btn btn-default" onClick="adm_report_next_page();">下一页</button></div></td><td></td><td></td><td></td>');
            } else {
                $("#inf_title").empty();
                $("#inf_area").empty();
				$("#inf_area").append('<p id="inf_detail"></p>');
                $("#inf_title").append('暂无报表');
                $("#inf_detail").append('当前暂无可用数据!');
                $("#inf_table").empty();
            }
			$('[data-toggle="popover"]').popover({html:true});
        }
    },
    'json');
}
function adm_report_next_page() {
    if((reportdata.page + 1) * reportdata.capa < reportdata.tot_num){
        reportdata.page += 1;
        adm_getnewtable_report();
    }
    
}
function adm_report_front_page() {
    if(reportdata.page > 0){
        reportdata.page -= 1;
        adm_getnewtable_report();
    }
    
}
function adm_report_search() {
    $("#inf_table").empty();
    var search_str = encode64($("#search_input").val());
    $.post("interface.php", {
        "datamgr":'query_item',
        "require":"datamanager",
        "type":adm_searchopt,
        "content":search_str
    },
    function(data) {
        if (data.error === 0) {
            if (data.contentlen > 0) {
                $("#inf_title").empty();
                $("#inf_area").empty();
                $("#inf_area").append('<p id="inf_detail"></p>');
                $("#inf_title").append('查询结果');
                $("#inf_detail").append('查询到'+data.contentlen+'条结果!');
				$("#inf_table").empty();
                $("#inf_table_title").empty();
                $("#inf_table_title").append('<tr><th>报修ID</th><th>姓名</th><th>学号</th><th>电话号码</th><th>住址</th><th>描述</th><th>处理人</th><th>处理结果</th></tr>');
                //console.log("report");
                for(var i = 0; i < data.contentlen; i++) {
                    var remark = decode64(data[i].remark);
                    var remarkmin = remark;
                    if (remark.length >= 21) {
                        remarkmin = remark.substr(0, 20) + "...";
                    }
                    if(decode64(data[i].status) == "0"){
                        $("#inf_table").append('<tr class="success"><td>' + data[i].repairid + '</td><td>' + string_process(decode64(data[i].name)) + '</td><td>' + string_process(decode64(data[i].id)) + '</td><td>' + string_process(decode64(data[i].tel)) + '</td><td>' + string_process(decode64(data[i].buildnum)) + form1_bulnum + '-' + string_process(decode64(data[i].section)) + '-' + string_process(decode64(data[i].floor)) + form1_floor + '-' + string_process(decode64(data[i].roomnum)) + form1_room + '-' + string_process(decode64(data[i].roomside)) + '</td><td><span data-toggle="popover" data-placement="top" data-trigger="hover" data-content="' + string_process(remark) + '">' + string_process(remarkmin) + '</span></td><td>' + decode64(data[i].processer) + '</td><td>'+ '处理完成' + '</td></tr>');
                    }else{
                        $("#inf_table").append('<tr class="warning"><td>' + data[i].repairid + '</td><td>' + string_process(decode64(data[i].name)) + '</td><td>' + string_process(decode64(data[i].id)) + '</td><td>' + string_process(decode64(data[i].tel)) + '</td><td>' + string_process(decode64(data[i].buildnum)) + form1_bulnum + '-' + string_process(decode64(data[i].section)) + '-' + string_process(decode64(data[i].floor)) + form1_floor + '-' + string_process(decode64(data[i].roomnum)) + form1_room + '-' + string_process(decode64(data[i].roomside)) + '</td><td><span data-toggle="popover" data-placement="top" data-trigger="hover" data-content="' + string_process(remark) + '">' + string_process(remarkmin) + '</span></td><td>' + decode64(data[i].processer) + '</td><td>'+ '处理中' + '</td></tr>');
                    }
                }
            } else {
                $("#inf_title").empty();
                $("#inf_area").empty();
                $("#inf_area").append('<p id="inf_detail"></p>');
                $("#inf_title").append('查询结果');
                $("#inf_detail").append('没有查询到相应条目！');
                $("#inf_table").empty();
            }
            $('[data-toggle="popover"]').popover({html:true});
        }
    },
    'json');
}
function init_adm_report_table_title() {
	//$("#inf_table_title").empty();
	//$("#inf_table_title").append('<tr><th>报修ID</th><th>姓名</th><th>学号</th><th>电话号码</th><th>住址</th><th>描述</th><th>处理人</th><th>处理结果</th></tr>');
    $("#inf_table_title").empty();
    $("#inf_table").empty();
	$("#inf_table_title").append('<tr><th class="text-center"><strong style="cursor: pointer;" onClick="adm_getnewtable_report();">点击加载全部</strong></th></tr>');
}
function init_adm_report_summary() {
	$("#inf_title").empty();
	$("#inf_title").append('<strong>数据一览图</strong>');
	$("#inf_area").empty();
    $("#inf_area").append('<div class="col-md-5"><canvas id="summary_chart1" height="200px"></canvas></div><div class="col-md-7"><canvas id="summary_chart2" height="200px"></canvas></div>');
	//$("#inf_area").append('本功能尚未开放哦~');	
    $.post("interface.php", {
        "datamgr":'query_summary',
        "require":"datamanager"
    },
    function(data) {
        if (data.error === 0) {
            reportdata.tot_num = data.tot_count;
            if (data.contentlen > 0) {
                var ctx1 = $("#summary_chart1").get(0).getContext("2d");
                var ctx2 = $("#summary_chart2").get(0).getContext("2d");
                var datachart = {
                    labels : [],
                    datasets : [
                        {
                            label: "处理数量",
                            backgroundColor : "rgba(00, 113, 197,0.5)",
                            borderColor : "rgba(00, 113, 197,1)",
                            pointBorderColor : "rgba(00, 113, 197,1)",
                            data : []
                        },
                        {
                            label: "报修数量",
                            backgroundColor : "rgba(208, 208, 208,0.5)",
                            borderColor : "rgba(208, 208, 208,1)",
                            pointBorderColor : "rgba(208, 208, 208,1)",
                            data : []
                        }
                    ]
                }
                var options = {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero:true
                            }
                        }]
                    },
                    animation: {
                        duration: 2000
                    },
                    legend: {
                        position: 'right'
                    },
                    tooltips: {
                        position: 'nearest'
                    },
                    title: {
                        display: true,
                        position: 'top',
                        text: '近十周数据汇总'
                    }
                }
                for (var i = 9; i >= 0; i--) {
                    datachart.labels.push('第' + (data[0].weeknum - i) + '周');
                    var flag1 = 0;
                    var flag2 = 0;
                    for(var j = 0; j < 10; j++){
                        if((data[0].weeknum - i) == data[j].weeknum){
                            datachart.datasets[0].data.push(data[j].count);
                            var flag1 = 1;
                        }
                        if((data[0].weeknum - i) == data[j + 10].weeknum){
                            datachart.datasets[1].data.push(data[j + 10].count);
                            var flag2 = 1;
                        }
                        if( flag1 == 1 && flag2 == 1 ){
                            break;
                        }
                    }
                    if(flag1 == 0){
                        datachart.datasets[0].data.push(0);
                    }
                    if(flag2 == 0){
                        datachart.datasets[1].data.push(0);
                    }
                }
                var myNewChart = new Chart(ctx2, {
                                        type: 'line',
                                        data: datachart,
                                        options: options
                                    });
                
                var datachart = {
                    labels : [],
                    datasets : [
                        {
                            data : [],
                            backgroundColor: [
                                '#d9534f',
                                '#f0ad4e',
                                '#337ab7',
                                '#5cb85c',
                                '#5bc0de'
                            ]
                        }
                    ]
                }
                var options = {
                    animation: {
                        duration: 2000
                    },
                    legend: {
                        position: 'right'
                    },
                    tooltips: {
                        position: 'nearest'
                    },
                    title: {
                        display: true,
                        position: 'top',
                        text: '近一百条报修分布'
                    }
                }
                var buildsum = 100;
                for (var i = 20; i < 24; i++) {
                    datachart.labels.push(decode64(data[i].buildnum) + '#楼');
                    datachart.datasets[0].data.push(data[i].count);
                    buildsum -= data[i].count;
                }
                datachart.labels.push("其他");
                datachart.datasets[0].data.push(buildsum);
                var myNewChart = new Chart(ctx1, {
                                        type: 'pie',
                                        data: datachart,
                                        options: options
                                    });
                $("#inf_area").append('<p>目前系统已累计处理:<strong>' + data.tot_count + '</strong>例报修！</p>');
                $("#inf_area").append('<p id="refreash_display"></p>');
            }else{
                $("#inf_area").empty();
                $("#inf_area").append('统计器遇到严重问题！');
            }
        }
    },
    'json');
}
function init_adm_report() {
	adm_getnum();
	init_adm_report_summary();
	init_adm_report_table_title();
    if(auto_refreash.on == 0){
        auto_refreash.enable = 1;
        auto_refreash.on = 1;
        auto_refreash.counter = 15 * 60;
        setTimeout(adm_report_refreash,1000);
    }
	//adm_getnewtable_report();
	//$('[data-toggle="popover"]').popover(); 
}
function adm_report_refreash() {
    if(auto_refreash.enable == 0){
        auto_refreash.on = 0;
    }else{
        if(auto_refreash.counter <= 0){
            auto_refreash.counter = 15 * 60;
            init_adm_report();
        }else{
            auto_refreash.counter--;
            $("#refreash_display").empty();
            $("#refreash_display").append('页面将在' + parseInt(auto_refreash.counter / 60) + '分' + auto_refreash.counter % 60 + '秒后刷新');
        }
        setTimeout(adm_report_refreash,1000);
    }
}
    

//用户资料
function adm_my_profile() {
    $("#inf_table").empty();
	$.post("interface.php", {
        "usermgr": 'query_profile',
        "require":"usermanager"
    },
    function(data) {
        delaydata.data = data;
        if (data.error === 0) {
            if (data.contentlen > 0) {
				$("#inf_title").empty();
                $("#inf_area").empty();
                $("#inf_title").append('用户资料');
				$("#inf_area").append('<div class="col-md-10 col-md-offset-2"><form method="post" id="form" class="form-horizontal"><div class="form-group"><label for="adm_profile_name" class="col-sm-2 control-label">姓名:</label><div class="col-sm-5"><input type="text" class="form-control" id="adm_profile_name"/></div></div><div class="form-group"><label for="adm_profile_stuid" class="col-sm-2 control-label">学号:</label><div class="col-sm-5"><input type="text" class="form-control" onkeyup="this.value=this.value.replace(\/\\D\/g,\'\')" onafterpaste="this.value=this.value.replace(\/\\D\/g,\'\')" id="adm_profile_stuid" maxlength="11"/></div></div><div class="form-group"><label for="adm_profile_tel" class="col-sm-2 control-label">电话:</label><div class="col-sm-5"><input type="text" class="form-control" onkeyup="this.value=this.value.replace(\/\\D\/g,\'\')" onafterpaste="this.value=this.value.replace(\/\\D\/g,\'\')" id="adm_profile_tel" maxlength="11"/></div></div><div class="form-group"><label for="adm_profile_remark" class="col-sm-2 control-label">备注:</label><div class="col-sm-5"><p id="adm_profile_remark"></p></div></div></form></div>');
                $("#adm_profile_name").val(decode64(data[0].name));
                $("#adm_profile_stuid").val(decode64(data[0].id));
                $("#adm_profile_tel").val(decode64(data[0].tel));
                $("#adm_profile_remark").append(decode64(data[0].remark));
            } else {
                $("#inf_title").empty();
                $("#inf_area").empty();
				$("#inf_area").append('<p id="inf_detail"></p>');
                $("#inf_title").append('用户错误！');
                $("#inf_detail").append('请注销后重新登录!');
                $("#inf_table").empty();
            }
			//$('[data-toggle="popover"]').popover({html:true});
        }
    },
    'json');
}
function init_my_profile_table_title() {
	$("#inf_table_title").empty();
}
function init_my_profile() {
	adm_getnum();
	init_my_profile_table_title();
    adm_my_profile();
}

    
//用户管理
var successimg = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAZQTFRFAar/AAAAiqnrrAAAAAJ0Uk5T/wDltzBKAAAES0lEQVR42uzd23LcIAwGYP3v/9KdadquwQJs0HGr3GSyyRg+2xwtOYQv+aKCFOR/h9CXQIjoayD0DRCihYQyOWYSSuWYSCiXYyyhZI6hhLI5RhJK5xhIKJ+Dl1BCByuhjA5OQikdjIRyOu4SSuq4SSiro5dQWkcnobyOVkKJHY2EMjuuEkrtuEgotyM2ZMcREbLlCAjZc8SDbDrCQXYd0SDbjmCQfUcsyIEjFOTEEQly5AgEOXPEgRw6wkBOHVEgx44gkHNHCAgJOCJARBwBIDIOf4iQwx0i5fCGiDmcIXKOPBBEhgg6XCGSDk+IqMMRIuvwgwg73CDSDi+IuMMJIu/wgSg4oPGXHo7n1Xt1VHvHY8jb41o7nkJ2Dm3qeAjZPLih4zWEgjqeQU4KMHI8ghwWYeJ4AjkvxMDxACJSjLpjDZEqSNmxhMhdel3HMuFHrFNRdiwgcsOVtmMOkZvRqTumELm1gr5jBpFbhYaHUBzHBCK2c2biGEPE9mRtHEOI2G6/kWMEEXuOZMQYQUjoRNo5eAiRjMTQIXFFiAI4BNrIOF7H0gGBszkKaTN1HI8j42BJWwdEWioXhmvsgFDneQvwtnacrEdmqQPmDogNzNdKOTi21+yzank4IDnp+1MxF8fmvtasaj4OyC4ohOZoOhCkcEB6serl2Hg+EtMB+Y0QHwc09qY8HK+es0d2QGXf08HxJjAjtANKe+rmjnehMl8DQVwH9J482TpeR2FFdUDzqaalYyMuLqZjK8AvogPaQQxWjs2Qy3gO6AfI2Di2g2CjOWARfGXhOAhLjuVA0MA+UwgiOWARNIrwEMRxHOcgRHFAPUYcWSCI4YBy/gEyQRDBIZNwFMABzSwd5IPA3QG9DDDkhMDZoZZdiLwQwUwsbwgcHcK5un4O6aRjN4d49rSXAxT+gMHLLUhBClKQghSkIAUpSEEKUpB3oYDt960j/iwhaZrbpQ+hNeRB0uu0tkovr2CLaNJEtiBIAFnVxB/yKeEvhL/LFv9upq9ovz1pAWkKbiCrR1bPEpkMIb/rf4Es08PWkEvlz9688uqCXPvODrK4GYn5EB6QniAAgRfkclsfQLDo6D4oVUjXa10rOnv2docsfg3FNvJpJv8ae1+bVxBygmAFmQ1obcLl7a+MIcyA+HRg7zJH40Fw/7dxNLlMDyCkD7kWxkP6m2Zwmn86BnhB2O4XNB3VUkFoA8JMHN8t3o6nKNcn0N14MD2V7e94SHti9CB9/9NfEZoNye3ScvTKDlNIW6v+9QizuVQzced75tuaR2/N3qxB0E7UuY6VgdyaT7MWUYd0A1rf+XxOKA/pGsinUXQng7YXvO/fiX29i/kuazG5patmsBGkCeG3IG4f3meO/UpxsHPBtDflXut+FzP3PNuCwZCYn7cCWkQgGO6MjIuj6eiu8gbmHNvOtRtfkIIUpCAFKUhBClKQghSkIAX5+folwAAHBX6C5WcYiAAAAABJRU5ErkJggg==";
var wechatbind = {
    "key":'',
    "url":'',
    "bind":0
};
function adm_new_wechat_check() {
    $.post("interface.php",{
			"usermgr":"query_profile_new",
            "require":"usermanager"
		},function (data){
			if(data.error === 0){
                if (data.contentlen > 0) {
                    if(data[0].group === 1){
                        $("#adm_new_mgr").empty();
                        $("#adm_new_mgr").append("已经是管理员了，点击更换微信");
                        $("#adm_new_mgr").attr("onClick","adm_mgr_usr_clear_wechat();");
                    }
                    else{
                        $("#adm_new_mgr").empty();
                        $("#adm_new_mgr").append("提升为管理员");
                        $("#adm_new_mgr").attr("onClick","adm_mgr_usr_addnew();");
                    }
                    $("#adm_profile_name").val(decode64(data[0].name));
                    $("#adm_profile_stuid").val(decode64(data[0].id));
                    $("#adm_profile_tel").val(decode64(data[0].tel));
                    $("#adm_profile_name").attr("disabled", "disabled");
                    $("#adm_profile_stuid").attr("disabled", "disabled");
                    $("#adm_profile_tel").attr("disabled", "disabled");
                }
			}else if(data.error === 1){
				$('#addusr_fail').modal('show');
			}
		},
    'json');
}
function adm_check_wechatnew() {
    'use strict';
    $.post("interface.php",{
        "action":"query",
        "require":"wechatnew"
    },function(data) {
        if(data.error === 0){
            wechatbind.bind = data.bind;
            if(data.bind === 0){
                if(wechat_check.enable == 1){
                    setTimeout(adm_check_wechatnew,1000);
                }
            }else{
                //$("#qrcode img").removeAttr("src");
                $("#adm_qrcode img").attr("src",successimg);
                $("#adm_qrcode img").show();
                $("#adm_qrcode canvas").hide();
                adm_new_wechat_check();
            }
        }
    },'json');
}
function adm_wechat_makeCode() {
	'use strict';//生成二维码
	var qrcode = new QRCode(document.getElementById('adm_qrcode'), {					//定义二维码创建对象
		width: 200,
		height: 200,																//尺寸
		correctLevel: QRCode.CorrectLevel.L											//校验等级
	});
	$.post("interface.php",{													//与服务器通信
			"action":"wechatbind",												//传送参数
            "require":"wechatnew"
		},function(data){														//获取绑定状态
            if(data.error === 0){
                if(data.bind === 0){													//没有绑定微信则生成绑定二维码
                    //$("#wechatbind").empty();
                    //$("#wechatbind").append('<div id="qrcode" style="width:200px; height:200px; margin-top:15px;"></div>');
                    wechatbind.url = data.url;
                    wechatbind.key = data.key;
                    qrcode.makeCode(data.url);
                    wechat_check.enable = 1;
                    setTimeout(adm_check_wechatnew,1000);
                } else if(data.bind === 1){											//已经绑定则显示已经绑定的图片
                    //$("#wechatbind").empty();
                    //$("qrcode").removeAttr("src");
                    $("#adm_qrcode img").attr("src",successimg);
                    $("#adm_qrcode img").show();
                    $("#adm_qrcode canvas").hide();
                    wechatbind.bind = 1;
                    adm_new_wechat_check();
                }
            }
		},'json');
}
function adm_mgr_usr() {
    $("#inf_table").empty();
	$.post("interface.php", {
        "usermgr": 'query_mgr',
        "require":"usermanager"
    },
    function(data) {
        delaydata.data = data;
        if (data.error === 0) {
            if (data.contentlen > 0) {
				for (var i = 0; i < data.contentlen; i++) {
                    $("#inf_table").append('<tr><td>' + decode64(data[i].name) + '</td><td>' + decode64(data[i].id) +'</td><td>' + decode64(data[i].tel) + '</td><td>' + decode64(data[i].remark) + '</td><td>停用</td></tr>');
                }
            } else {
                $("#inf_title").empty();
                $("#inf_area").empty();
				$("#inf_area").append('<p id="inf_detail"></p>');
                $("#inf_title").append('权限错误！');
                $("#inf_detail").append('请注销后重新登录!');
                $("#inf_table").empty();
            }
			//$('[data-toggle="popover"]').popover({html:true});
        }
    },
    'json');
}
function adm_mgr_usr_clear_wechat() {
    $.post("interface.php",{													//与服务器通信
			"action":"wechatclear",												//传送参数
            "require":"wechatnew"
		},function(data){														//获取绑定状态
            if(data.error === 0){
                init_mgr_usr();
            }
		},'json');
}
function init_mgr_usr_form() {
    $("#inf_title").empty();
    $("#inf_area").empty();
    $("#inf_title").append('用户资料');
    $("#inf_area").append('<div class="col-md-10 col-md-offset-2"><form method="post" id="form" class="form-horizontal"><div class="form-group"><label for="adm_profile_name" class="col-sm-2 control-label">姓名:</label><div class="col-sm-5"><input type="text" class="form-control" id="adm_profile_name"/></div></div><div class="form-group"><label for="adm_profile_stuid" class="col-sm-2 control-label">学号:</label><div class="col-sm-5"><input type="text" class="form-control" onkeyup="this.value=this.value.replace(\/\\D\/g,\'\')" onafterpaste="this.value=this.value.replace(\/\\D\/g,\'\')" id="adm_profile_stuid" maxlength="11"/></div></div><div class="form-group"><label for="adm_profile_tel" class="col-sm-2 control-label">电话:</label><div class="col-sm-5"><input type="text" class="form-control" onkeyup="this.value=this.value.replace(\/\\D\/g,\'\')" onafterpaste="this.value=this.value.replace(\/\\D\/g,\'\')" id="adm_profile_tel" maxlength="11"/></div></div><div class="form-group"><label class="col-sm-2 control-label" id="label_wechat"></label><div class="col-sm-5" id="wechatbind"><div id="adm_qrcode" style="width:200px; height:200px; margin-top:15px;"></div></div><div class="col-sm-5 hidden-md hidden-lg" id="wechatbindurl"></div></div><div class="form-group"><div class="col-lg-3 col-lg-offset-3"><button type="button" id="adm_new_mgr" class="btn btn-primary btn-lg btn-block" onClick="adm_mgr_usr_addnew()">添加管理员</button></div></div></form></div>');
    adm_wechat_makeCode();
}
function adm_mgr_usr_addnew() {
    if(
        $("#adm_profile_name").val() !== "" &&
		$("#adm_profile_stuid").val() !== "" &&
		$("#adm_profile_tel").val() !== "" &&					//逐个判断是否为空值
        wechatbind.bind === 1){
        var adm_name = encode64($("#adm_profile_name").val());
        var adm_stuid = encode64($("#adm_profile_stuid").val());
        var adm_tel = encode64($("#adm_profile_tel").val());
        $.post("interface.php",{
			"name":adm_name,
			"stuid":adm_stuid,
			"tel":adm_tel,
			"usermgr":"new_admin",
            "require":"usermanager"
		},function (data){
			if(data.error === 0){
				adm_mgr_usr_clear_wechat();
			}else if(data.error === 1){
				$('#addusr_fail').modal('show');
			}
		},'json');
    }
    else{
        $('#addusr_fail').modal('show');
    }
}
function init_mgr_usr_table_title() {
	$("#inf_table_title").empty();
    $("#inf_table_title").append('<tr><th>姓名</th><th>学号</th><th>电话号码</th><th>备注</th><th>管理</th></tr>');
}
function init_mgr_usr() {
	adm_getnum();
	init_mgr_usr_table_title();
    init_mgr_usr_form();
    adm_mgr_usr();
}


//抢票管理
function init_qiangpiao_mgr_abstract() {
    $("#inf_title").empty();
    $("#inf_title").append('抢票名单');
	$("#inf_area").empty();
    $("#inf_area").append('<p id="inf_detail"></p>');
    $("#inf_detail").append('以下为抢票名单!');
}
function init_qiangpiao_mgr_table(){
    $("#inf_table").empty();
    $.post("interface.php", {
        "datamgr": 'query_qiangpiao',
        "require":"datamanager"
    },
    function(data) {
        if (data.error === 0) {
            if (data.contentlen > 0) {
				$("#inf_table").empty();
                for (var i = 0; i < data.contentlen; i++) {
                        $("#inf_table").append('<tr><td>' + data[i].id + '<td>' + string_process(decode64(data[i].name)) + '</td><td>' + string_process(decode64(data[i].stuid)) + '</td><td>' + string_process(decode64(data[i].tel)) + '</td><td>' + string_process(decode64(data[i].tkt_name)) + '</td><td>' + string_process(decode64(data[i].chang)) + '</td><td>' + string_process(decode64(data[i].ci)) + '</td></tr>'); 
                }
            } else {
            }
        }
    },
    'json');
}
function init_qiangpiao_mgr_table_title() {
	$("#inf_table_title").empty();
    $("#inf_table_title").append('<tr><th>编号</th><th>姓名</th><th>学号</th><th>电话号码</th><th>票面</th><th>票场</th><th>票次</th></tr>');
}
function init_qiangpiao_mgr() {
	adm_getnum();
    init_qiangpiao_mgr_abstract();
	init_qiangpiao_mgr_table_title();
    init_qiangpiao_mgr_table();
}
    
//adm 导出报表
var exportdata = {
	"data":""
}
function adm_getfile_export() {
    $("#inf_table").empty();
    var date_start = $("#select_time_start").val() + " ";
    var date_stop = $("#select_time_stop").val() + " ";
    $("#adm_export_submit").attr("disabled","disabled");
    $("#adm_export_submit").empty();
    $("#adm_export_submit").append("处理中...");
	$.post("interface.php", {
        "datamgr": 'query_export',
        "start_time": date_start,
        "stop_time": date_stop,
        "require":"datamanager"
    },
    function(data) {
        if (data.error === 0) {
            exportdata.data = data;
            if (data.contentlen > 0) {
                var export_file = "报修ID,姓名,学号,电话,住址,报修时间,完成时间,完成状态,处理人\n";
                for (var i = 0; i < data.contentlen; i++) {
                    var status;
                    if(decode64(data[i].status) == "0"){
                        status = "处理成功";
                    }else{
                        status = "处理中";
                    }
                    export_file += data[i].repairid + ',' + decode64(data[i].name) + ',' + decode64(data[i].id) + ',' + decode64(data[i].tel) + ',' + decode64(data[i].buildnum) + form1_bulnum + '-' + decode64(data[i].section) + '-' + decode64(data[i].floor) + form1_floor + '-' + decode64(data[i].roomnum) + form1_room + '-' + decode64(data[i].roomside) + ',' + decode64(data[i].timestart) + ',' + decode64(data[i].timestop) + ',' + status + ',' + decode64(data[i].processer) + '\n';
                }
                var exportContent = "\uFEFF";
                var blob = new Blob([exportContent + export_file],{type: "text/plain;charset=utf-8"});
                saveAs(blob, "报修记录_" + date_start + "_" + date_stop + ".csv");
            } else {
            }
            $("#adm_export_submit").empty();
            $("#adm_export_submit").append("导出");
            $("#adm_export_submit").removeAttr("disabled");
			$('[data-toggle="popover"]').popover({html:true});
        }
    },
    'json');
}
function adm_table_export_presubmit() {
    var date_start = $("#select_time_start").val() + " ";
    var date_stop = $("#select_time_stop").val() + " ";
    $('#datetimepicker_stop').datetimepicker('setStartDate',date_start);
    $('#datetimepicker_start').datetimepicker('setEndDate',date_stop);
	if($("#select_time_start").val() !== '' && $("#select_time_stop").val() !== ''){
		$("#adm_export_submit").removeAttr("disabled");
	}else{
        $("#adm_export_submit").attr("disabled","disabled");
    }
}
function init_adm_export_table_title() {
	$("#inf_table_title").empty();
    $("#inf_table").empty();
}
function init_adm_export_select() {
	$("#inf_title").empty();
	$("#inf_title").append('<strong>导出条件</strong>');
	$("#inf_area").empty();
    $("#inf_area").append('<div class="form-group col-lg-6 col-lg-offset-3"><div class="input-append date" id="datetimepicker_start" data-date-format="yyyy-mm-dd"><label class="col-lg-3 control-label">起始时间：</label><div class="col-lg-9"><input class="form-control span2" id="select_time_start" style="cursor: pointer;" size="16" type="text" onchange="adm_table_export_presubmit();" readonly><span class="add-on"><i class="icon-th"></i></span></div></div><div class="input-append date" id="datetimepicker_stop" data-date-format="yyyy-mm-dd"><label class="col-lg-3 control-label">结束时间：</label><div class="col-lg-9"><input class="form-control span2" id="select_time_stop" style="cursor: pointer;" size="16" type="text" onchange="adm_table_export_presubmit();" readonly><span class="add-on"><i class="icon-th"></i></span></div></div><div><div class="col-lg-3 col-lg-offset-6"><button class="btn btn-primary btn-lg btn-block" id="adm_export_submit" onClick="adm_getfile_export();" disabled>导出</button></div></div></div>');
	var myDate = new Date();
    var date_conf = {
        language:  'zh-CN',
        weekStart: 0,
        todayBtn:  0,
        startDate: "2017-09-01",
        endDate: myDate.getFullYear().toString() + '-' + (myDate.getMonth() + 1).toString() + '-' + myDate.getDate().toString(),
        daysOfWeekDisabled: [],
		autoclose: 1,
		todayHighlight: 1,
		startView: 2,
		minView: 2,
		forceParse: 0
    }
	$('#datetimepicker_start').datetimepicker(date_conf);
    $('#datetimepicker_stop').datetimepicker(date_conf);
	
}
function init_adm_export() {
	adm_getnum();
	init_adm_export_select();
	init_adm_export_table_title();
}
    
//页面管理
function adm_mgr_page() {
    $("#inf_table").empty();
	$.post("interface.php", {
        "pagemgr": 'query_page',
        "require":"pageeditor"
    },
    function(data) {
        delaydata.data = data;
        if (data.error === 0) {
            if (data.contentlen > 0) {
				for (var i = 0; i < data.contentlen; i++) {
                    var name_str = '';
                    if(data[i].type === "page"){
                        name_str = 'HTML页面';
                    }
                    else if(data[i].type === "jsmanager"){
                        name_str = 'JavaScript函数库';
                    }
                    else if(data[i].type === "jsexecutor"){
                        name_str = 'JavaScript命令';
                    }
                    
                    var remark = '无';
                    if(data[i].remark !== null)
                    {
                        remark = decode64(data[i].remark);
                    }
					var remarkmin = remark;
                    if (remark.length >= 21) {
                        remarkmin = remark.substr(0, 20) + "...";
                    }
                    
                    if(data[i].enable === '1'){
                        $("#inf_table").append('<tr class="success"><td>' + name_str + '</td><td>' + decode64(data[i].name) +'</td><td><span data-toggle="popover" data-placement="top" data-trigger="hover" data-content="' + remark + '">' + remarkmin + '</span></td><td>已启用</td><td><a style="cursor: pointer;" onClick="init_mgr_page_edit(\'' + data[i].type + '\',\'' + name_str + '\',\'' + decode64(data[i].name) + '\');">编辑</a>&nbsp;<a style="cursor: pointer;" onClick="adm_mgr_page_disable(\'' + data[i].type + '\',\'' + decode64(data[i].name) + '\');">停用</a></td></tr>');
                    }
                    else{
                        $("#inf_table").append('<tr class="danger"><td>' + name_str + '</td><td>' + decode64(data[i].name) +'</td><td><span data-toggle="popover" data-placement="top" data-trigger="hover" data-content="' + remark + '">' + remarkmin + '</span></td><td>已停用</td><td><a style="cursor: pointer;" onClick="init_mgr_page_edit(\'' + data[i].type + '\',\'' + name_str + '\',\'' + decode64(data[i].name) + '\');">编辑</a>&nbsp;<a style="cursor: pointer;" onClick="adm_mgr_page_enable(\'' + data[i].type + '\',\'' + decode64(data[i].name) + '\');">启用</a></td></tr>');
                    }
                    
                }
            } else {
                $("#inf_title").empty();
                $("#inf_area").empty();
				$("#inf_area").append('<p id="inf_detail"></p>');
                $("#inf_title").append('权限错误！');
                $("#inf_detail").append('请注销后重新登录!');
                $("#inf_table").empty();
            }
			$('[data-toggle="popover"]').popover({html:true});
        }
    },
    'json');
}
function init_mgr_page_add() {
    $("#inf_title").empty();
    $("#inf_area").empty();
    $("#inf_title").append('添加页面');
    $("#inf_area").append('<div class="col-md-12"><form method="post" id="form" class="form-horizontal"><div class="col-md-12"><div class="form-group"><label for="adm_page_name" class="col-sm-1 control-label">页面名称:</label><div class="col-sm-5"><input type="text" class="form-control" id="adm_page_name"/></div></div><form method="post" id="form" class="form-horizontal"><div class="form-group"><label for="adm_page_type" class="col-sm-1 control-label">页面类型:</label><div class="col-sm-5"><select id="adm_page_type" class="form-control"><option value ="page">HTML页面</option><option value ="jsmanager">JavaScript函数库</option><option value="jsexecuter">JavaScript命令</option></select></div></div><div class="form-group"><label for="adm_page_path" class="col-sm-1 control-label">页面路径:</label><div class="col-sm-11"><input type="text" class="form-control" id="adm_page_path"/></div></div><div class="form-group"><label for="adm_page_content" class="col-sm-1 control-label">页面内容:</label><div class="col-sm-11"><textarea class="form-control" rows="15" id="adm_page_content">In the file</textarea></div></div><div class="form-group"><label for="adm_page_remark" class="col-sm-1 control-label">页面备注:</label><div class="col-sm-11"><input type="text" class="form-control" id="adm_page_remark"/></div></div><div class="col-lg-3 col-lg-offset-3"><button type="button" id="adm_new_mgr" class="btn btn-primary btn-lg btn-block" onClick="adm_mgr_page_addnew()">添加页面</button></div></form></div>');
}
function init_mgr_page_edit(type,type_str,name) {
    $("#inf_title").empty();
    $("#inf_area").empty();
    $("#inf_title").append('编辑页面 - ' + type_str + ' - ' + name);
    $("#inf_area").append('<div class="col-md-12"><form method="post" id="form" class="form-horizontal"><div class="form-group"><label for="adm_page_name" class="col-sm-1 control-label">页面名称:</label><div class="col-sm-5"><input type="text" class="form-control" id="adm_page_name"/></div></div><div class="form-group"><label for="adm_page_path" class="col-sm-1 control-label">页面路径:</label><div class="col-sm-11"><input type="text" class="form-control" id="adm_page_path"/></div></div><div class="form-group"><label for="adm_page_content" class="col-sm-1 control-label">页面内容:</label><div class="col-sm-11"><textarea class="form-control" rows="15" id="adm_page_content">In the file</textarea></div></div><div class="form-group"><label for="adm_page_remark" class="col-sm-1 control-label">页面备注:</label><div class="col-sm-11"><input type="text" class="form-control" id="adm_page_remark"/></div></div><div class="col-lg-3 col-lg-offset-3"><button type="button" id="adm_new_mgr" class="btn btn-primary btn-lg btn-block" onClick="adm_mgr_page_edit(\'' + type +'\',\'' + name +'\')">保存</button></div></form></div>');
    $.post("interface.php", {
        "type":encode64(type),
        "name":encode64(name),
        "pagemgr": 'query_content',
        "require":"pageeditor"
    },
    function(data) {
        delaydata.data = data;
        if (data.error === 0) {
            if (data.contentlen > 0) {
				if (data.contentlen === 1) {
                    $("#adm_page_name").val(name);

                    if(data[0].path !== null){
                        $("#adm_page_path").val(decode64(data[0].path));
                    }
                    if(data[0].content !== null){
                        $("#adm_page_content").val(decode64(data[0].content));
                    }
                    if(data[0].remark !== null){
                        $("#adm_page_remark").val(decode64(data[0].remark));
                    }
                }
            } else {
                $("#inf_title").empty();
                $("#inf_area").empty();
				$("#inf_area").append('<p id="inf_detail"></p>');
                $("#inf_title").append('权限错误！');
                $("#inf_detail").append('请注销后重新登录!');
                $("#inf_table").empty();
            }
			//$('[data-toggle="popover"]').popover({html:true});
        }
    },
    'json');
}
function adm_mgr_page_enable(type,name) {
    $.post("interface.php",{
        "type":encode64(type),
        "name":encode64(name),
        "pagemgr":"enable_page",
        "require":"pageeditor"
    },function (data){
        if(data.error === 0){
            adm_mgr_page();
        }else if(data.error === 1){
            //
        }
    },'json');
}
function adm_mgr_page_disable(type,name) {
    $.post("interface.php",{
        "type":encode64(type),
        "name":encode64(name),
        "pagemgr":"disable_page",
        "require":"pageeditor"
    },function (data){
        if(data.error === 0){
            adm_mgr_page();
        }else if(data.error === 1){
            //
        }
    },'json');
}
function adm_mgr_page_addnew() {
    if($("#adm_page_name").val() !== ""){
        var page_name = encode64($("#adm_page_name").val());
        var page_path = '';
        var page_content = '';
        var page_remark = '';
        var page_type = encode64($("#adm_page_type").val());
        
        if($("#adm_page_remark").val() !== null){
            page_remark = encode64($("#adm_page_remark").val());
        }
        if($("#adm_page_content").val() !== null){
            page_content = encode64($("#adm_page_content").val());
        }
        if($("#adm_page_path").val() !== null){
            adm_page_path = encode64($("#adm_page_path").val());
        }
        
        $.post("interface.php",{
			"name":page_name,
			"path":page_path,
			"content":page_content,
            "remark":page_remark,
            "type":page_type,
			"pagemgr":"add_page",
            "require":"pageeditor"
		},function (data){
			if(data.error === 0){
				init_mgr_page();
			}else if(data.error === 1){
                //
			}
		},'json');
    }
    else{
        //
    }
}
function adm_mgr_page_edit(type,name) {
    if($("#adm_page_name").val() !== ""){
        var page_name = encode64(name);
        var page_path = '';
        var page_content = '';
        var page_remark = '';
        var page_type = encode64(type);
        
        if($("#adm_page_remark").val() !== null){
            page_remark = encode64($("#adm_page_remark").val());
        }
        if($("#adm_page_content").val() !== null){
            page_content = encode64($("#adm_page_content").val());
        }
        if($("#adm_page_path").val() !== null){
            page_path = encode64($("#adm_page_path").val());
        }
        
        $.post("interface.php",{
			"name":page_name,
			"path":page_path,
			"content":page_content,
            "remark":page_remark,
            "type":page_type,
			"pagemgr":"edit_page",
            "require":"pageeditor"
		},function (data){
			if(data.error === 0){
				init_mgr_page();
			}else if(data.error === 1){
                //
			}
		},'json');
    }
    else{
        //
    }
}
function init_mgr_page_table_title() {
	$("#inf_table_title").empty();
    $("#inf_table_title").append('<tr><th>类型</th><th>名称</th><th>备注</th><th>状态</th><th>操作</th></tr>');
}
function init_mgr_page() {
	adm_getnum();
	init_mgr_page_table_title();
    init_mgr_page_add();
    adm_mgr_page();
}
    
init_adm_confirm();
</script> 
